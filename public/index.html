<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AnyRouter ç®€æ˜“æ‰“å¡ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .main-content {
            padding: 30px;
        }

        .card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid #e9ecef;
        }

        .card h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-right: 15px;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%);
        }

        .btn-warning {
            background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
        }

        .btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        .status-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .status-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border: 2px solid #e9ecef;
            transition: transform 0.2s;
        }

        .status-card:hover {
            transform: translateY(-2px);
        }

        .status-card h3 {
            color: #333;
            margin-bottom: 10px;
        }

        .status-card .value {
            font-size: 1.5em;
            font-weight: bold;
            color: #667eea;
        }

        .login-status {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: 500;
            text-align: center;
        }

        .login-status.logged-in {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .login-status.logged-out {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .login-status.unknown {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .records-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .records-table th,
        .records-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }

        .records-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #555;
        }

        .status-success {
            color: #28a745;
            font-weight: bold;
        }

        .status-failed {
            color: #dc3545;
            font-weight: bold;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .loading.show {
            display: block;
        }

        .message {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: 500;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .info-box {
            background: #e7f3ff;
            border: 1px solid #b3d7ff;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }

        .info-box h4 {
            color: #0056b3;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .info-box ol {
            margin-left: 20px;
        }

        .info-box li {
            margin-bottom: 8px;
            line-height: 1.5;
        }

        @media (max-width: 768px) {
            .main-content {
                padding: 20px;
            }

            .status-panel {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 2em;
            }

            .btn {
                margin-right: 10px;
                margin-bottom: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸŒ AnyRouter ç®€æ˜“æ‰“å¡ç³»ç»Ÿ</h1>
            <p>æ‰‹åŠ¨ç™»å½•ä¸€æ¬¡ï¼Œè‡ªåŠ¨æ¯æ—¥æ‰“å¡</p>
        </div>

        <div class="main-content">
            <!-- ä½¿ç”¨è¯´æ˜ -->
            <div class="info-box">
                <h4>ğŸ“‹ ä½¿ç”¨è¯´æ˜</h4>
                <ol>
                    <li><strong>ç‚¹å‡»"æ‰“å¼€æµè§ˆå™¨ç™»å½•"</strong> - ç³»ç»Ÿä¼šæ‰“å¼€ä¸€ä¸ªæµè§ˆå™¨çª—å£</li>
                    <li><strong>æ‰‹åŠ¨ç™»å½•AnyRouter</strong> - åœ¨æµè§ˆå™¨ä¸­å®ŒæˆGitHub OAuthç™»å½•æˆ–è´¦å·å¯†ç ç™»å½•</li>
                    <li><strong>è‡ªåŠ¨æå–ç”¨æˆ·ä¿¡æ¯</strong> - ç™»å½•æˆåŠŸåï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨æå–å¹¶ä¿å­˜æ‚¨çš„ç”¨æˆ·IDå’ŒCookie</li>
                    <li><strong>ä¿æŒç™»å½•çŠ¶æ€</strong> - ç™»å½•ä¿¡æ¯ä¼šè‡ªåŠ¨ä¿å­˜ï¼Œæ— éœ€é‡å¤ç™»å½•</li>
                    <li><strong>è‡ªåŠ¨å®šæ—¶æ‰“å¡</strong> - æ¯å¤©æ—©ä¸Š6ç‚¹è‡ªåŠ¨æ£€æŸ¥å¥–åŠ±ï¼Œæ¯ä¸¤å°æ—¶ä¹Ÿä¼šè‡ªåŠ¨æ£€æŸ¥ä¸€æ¬¡</li>
                    <li><strong>æ‰‹åŠ¨æ£€æŸ¥</strong> - ä¹Ÿå¯éšæ—¶ç‚¹å‡»"ç«‹å³æ£€æŸ¥"æ‰‹åŠ¨è·å–å¥–åŠ±</li>
                </ol>
                <p style="margin-top: 15px; padding: 10px; background: #d4edda; border-left: 4px solid #28a745; color: #155724;">
                    <strong>âœ… å…¨è‡ªåŠ¨åŒ–:</strong> ç³»ç»Ÿä¼šåœ¨æ‚¨ç™»å½•åè‡ªåŠ¨æå–ç”¨æˆ·IDï¼Œæ— éœ€æ‰‹åŠ¨è¾“å…¥ä»»ä½•ä¿¡æ¯ã€‚
                </p>
            </div>

            <!-- çŠ¶æ€é¢æ¿ -->
            <div class="status-panel">
                <div class="status-card">
                    <h3>ğŸ“… ä»Šæ—¥çŠ¶æ€</h3>
                    <div class="value" id="todayStatus">æœªæ£€æŸ¥</div>
                </div>
                <div class="status-card">
                    <h3>ğŸ’° å½“å‰ä½™é¢</h3>
                    <div class="value" id="currentBalance">--</div>
                </div>
                <div class="status-card">
                    <h3>ğŸ ä»Šæ—¥å¥–åŠ±</h3>
                    <div class="value" id="todayReward">--</div>
                </div>
                <div class="status-card">
                    <h3>ğŸ”¥ è¿ç»­å¤©æ•°</h3>
                    <div class="value" id="streakDays">--</div>
                </div>
            </div>

            <!-- ç™»å½•çŠ¶æ€ -->
            <div class="login-status unknown" id="loginStatus">
                ğŸ” ç™»å½•çŠ¶æ€æ£€æŸ¥ä¸­...
            </div>

            <!-- æ“ä½œæŒ‰é’® -->
            <div class="card">
                <h2>ğŸ® æ“ä½œé¢æ¿</h2>
                <button class="btn" onclick="openForLogin()">ğŸš€ æ‰“å¼€æµè§ˆå™¨ç™»å½•</button>
                <button class="btn" onclick="checkLoginStatus()">ğŸ” æ£€æŸ¥ç™»å½•çŠ¶æ€</button>
                <button class="btn btn-success" onclick="manualCheck()">âœ… ç«‹å³æ£€æŸ¥å¥–åŠ±</button>
                <button class="btn btn-warning" onclick="loadRecords()">ğŸ“Š åˆ·æ–°è®°å½•</button>
                <button class="btn btn-danger" onclick="closeBrowser()">âŒ å…³é—­æµè§ˆå™¨</button>
            </div>

            <!-- Cookie ç®¡ç† -->
            <div class="card">
                <h2>ğŸª Cookie ç®¡ç†</h2>

                <!-- äº‘éƒ¨ç½²æç¤º -->
                <div style="background: #fff3cd; border: 1px solid #ffc107; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                    <strong>â˜ï¸ äº‘éƒ¨ç½²ç”¨æˆ·æ³¨æ„:</strong>
                    <p style="margin: 10px 0 0 0; line-height: 1.6;">
                        å¦‚æœæ‚¨éƒ¨ç½²åœ¨äº‘å¹³å°(å¦‚ Zeabur),æ— æ³•æ‰“å¼€æµè§ˆå™¨ç™»å½•,è¯·æ‰‹åŠ¨å¯¼å…¥ Cookie:<br>
                        1. åœ¨æµè§ˆå™¨è®¿é—® <a href="https://anyrouter.top" target="_blank">anyrouter.top</a> å¹¶ç™»å½•<br>
                        2. æŒ‰ F12 æ‰“å¼€å¼€å‘è€…å·¥å…· â†’ Console(æ§åˆ¶å°)<br>
                        3. è¾“å…¥å‘½ä»¤: <code style="background: #f8f9fa; padding: 2px 6px; border-radius: 3px;">document.cookie</code> å¹¶å›è½¦<br>
                        4. å¤åˆ¶è¾“å‡ºçš„ Cookie å­—ç¬¦ä¸²<br>
                        5. ç²˜è´´åˆ°ä¸‹æ–¹è¾“å…¥æ¡†å¹¶ç‚¹å‡»"å¯¼å…¥ Cookie"
                    </p>
                </div>

                <!-- å¯¼å…¥ Cookie -->
                <div style="background: #e7f3ff; border: 1px solid #b3d7ff; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                    <h3 style="margin: 0 0 10px 0;">ğŸ“¥ å¯¼å…¥ Cookie</h3>
                    <textarea
                        id="cookieInput"
                        placeholder="ç²˜è´´ä»æµè§ˆå™¨å¤åˆ¶çš„ Cookie å­—ç¬¦ä¸²,æ ¼å¼å¦‚: session=xxx; other=yyy"
                        style="width: 100%; min-height: 100px; padding: 10px; border: 1px solid #ccc; border-radius: 5px; font-family: monospace; font-size: 12px; resize: vertical;"
                    ></textarea>
                    <div style="margin-top: 10px;">
                        <button class="btn btn-success" onclick="importCookies()">âœ… å¯¼å…¥ Cookie</button>
                        <button class="btn" onclick="document.getElementById('cookieInput').value = ''">ğŸ—‘ï¸ æ¸…ç©ºè¾“å…¥</button>
                    </div>
                </div>

                <!-- æŸ¥çœ‹å·²ä¿å­˜çš„ Cookie -->
                <div style="margin-bottom: 15px;">
                    <button class="btn" onclick="loadCookies()">ğŸ”„ åˆ·æ–° Cookie</button>
                    <button class="btn btn-danger" onclick="clearCookies()">ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰ Cookie</button>
                </div>
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; position: relative;">
                    <div style="margin-bottom: 10px; display: flex; align-items: center; gap: 10px;">
                        <strong>å·²ä¿å­˜çš„ Cookie:</strong>
                        <button class="btn" style="padding: 5px 10px; font-size: 12px;" onclick="toggleCookieVisibility()">
                            <span id="eyeIcon">ğŸ‘ï¸</span> <span id="eyeText">æ˜¾ç¤º</span>
                        </button>
                        <button class="btn" style="padding: 5px 10px; font-size: 12px;" onclick="copyCookies()">
                            ğŸ“‹ å¤åˆ¶
                        </button>
                    </div>
                    <pre id="cookieDisplay" style="background: white; padding: 10px; border-radius: 5px; margin: 0; word-wrap: break-word; white-space: pre-wrap; font-family: monospace; font-size: 12px; max-height: 200px; overflow-y: auto;">æš‚æ—  Cookie</pre>
                </div>
            </div>

            <!-- åŠ è½½æç¤º -->
            <div class="loading" id="loading">
                <p>â³ æ­£åœ¨å¤„ç†ï¼Œè¯·ç¨å€™...</p>
            </div>

            <!-- æ¶ˆæ¯æ˜¾ç¤º -->
            <div id="messageArea"></div>

            <!-- æ£€æŸ¥è®°å½• -->
            <div class="card">
                <h2>ğŸ“ˆ æ‰“å¡è®°å½•</h2>
                <table class="records-table" id="recordsTable">
                    <thead>
                        <tr>
                            <th>æ—¥æœŸ</th>
                            <th>çŠ¶æ€</th>
                            <th>ä½™é¢</th>
                            <th>å¥–åŠ±</th>
                            <th>æ¶ˆæ¯</th>
                        </tr>
                    </thead>
                    <tbody id="recordsBody">
                        <tr>
                            <td colspan="5" style="text-align: center; color: #999;">æš‚æ— è®°å½•</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadRecords();
            updateTodayStatus();
            checkLoginStatus();
            loadCookies(); // åŠ è½½ Cookie
        });

        // Cookie ç®¡ç†ç›¸å…³
        let cookiesData = null;
        let cookiesVisible = false;

        // åŠ è½½ Cookie
        async function loadCookies() {
            try {
                const response = await fetch('/api/cookies');
                const data = await response.json();

                if (data.success) {
                    cookiesData = data.cookiesString || '';
                    updateCookieDisplay();
                }
            } catch (error) {
                console.error('åŠ è½½ Cookie å¤±è´¥:', error);
            }
        }

        // æ›´æ–° Cookie æ˜¾ç¤º
        function updateCookieDisplay() {
            const displayElement = document.getElementById('cookieDisplay');
            if (!cookiesData || cookiesData.length === 0) {
                displayElement.textContent = 'æš‚æ—  Cookie';
                return;
            }

            if (cookiesVisible) {
                displayElement.textContent = cookiesData;
            } else {
                displayElement.textContent = 'â—'.repeat(Math.min(cookiesData.length, 100));
            }
        }

        // åˆ‡æ¢ Cookie å¯è§æ€§
        function toggleCookieVisibility() {
            cookiesVisible = !cookiesVisible;
            const eyeIcon = document.getElementById('eyeIcon');
            const eyeText = document.getElementById('eyeText');

            if (cookiesVisible) {
                eyeIcon.textContent = 'ğŸ™ˆ';
                eyeText.textContent = 'éšè—';
            } else {
                eyeIcon.textContent = 'ğŸ‘ï¸';
                eyeText.textContent = 'æ˜¾ç¤º';
            }

            updateCookieDisplay();
        }

        // å¤åˆ¶ Cookie
        async function copyCookies() {
            if (!cookiesData || cookiesData.length === 0) {
                showMessage('æ²¡æœ‰å¯å¤åˆ¶çš„ Cookie', 'error');
                return;
            }

            try {
                await navigator.clipboard.writeText(cookiesData);
                showMessage('Cookie å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
            } catch (error) {
                // å¦‚æœ clipboard API ä¸å¯ç”¨ï¼Œä½¿ç”¨ä¼ ç»Ÿæ–¹æ³•
                const textarea = document.createElement('textarea');
                textarea.value = cookiesData;
                textarea.style.position = 'fixed';
                textarea.style.opacity = '0';
                document.body.appendChild(textarea);
                textarea.select();
                try {
                    document.execCommand('copy');
                    showMessage('Cookie å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
                } catch (e) {
                    showMessage('å¤åˆ¶å¤±è´¥', 'error');
                }
                document.body.removeChild(textarea);
            }
        }

        // å¯¼å…¥ Cookie
        async function importCookies() {
            const cookieString = document.getElementById('cookieInput').value.trim();

            if (!cookieString) {
                showMessage('è¯·è¾“å…¥ Cookie å­—ç¬¦ä¸²', 'error');
                return;
            }

            showLoading(true);

            try {
                // è§£æ Cookie å­—ç¬¦ä¸²ä¸ºæ•°ç»„
                const cookies = cookieString.split(';').map(c => {
                    const [name, ...valueParts] = c.trim().split('=');
                    return {
                        name: name.trim(),
                        value: valueParts.join('=').trim(),
                        domain: 'anyrouter.top',
                        path: '/',
                        secure: true,
                        httpOnly: false
                    };
                }).filter(c => c.name && c.value);

                if (cookies.length === 0) {
                    showMessage('æ— æ³•è§£æ Cookie,è¯·æ£€æŸ¥æ ¼å¼', 'error');
                    showLoading(false);
                    return;
                }

                console.log('å‡†å¤‡å¯¼å…¥çš„ Cookie æ•°é‡:', cookies.length);
                console.log('Cookie æ•°æ®:', cookies);

                // è°ƒç”¨å¯¼å…¥ API
                const response = await fetch('/api/import-cookies', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        cookies: cookies
                    })
                });

                console.log('API å“åº”çŠ¶æ€:', response.status);

                const data = await response.json();
                console.log('API å“åº”æ•°æ®:', data);

                if (response.ok) {
                    showMessage(`âœ… ${data.message}`, 'success');
                    document.getElementById('cookieInput').value = '';
                    // åˆ·æ–°æ˜¾ç¤º
                    await loadCookies();
                    await checkLoginStatus();
                } else {
                    showMessage(data.error || 'å¯¼å…¥å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('å¯¼å…¥ Cookie è¯¦ç»†é”™è¯¯:', error);
                console.error('é”™è¯¯ç±»å‹:', error.constructor.name);
                console.error('é”™è¯¯æ¶ˆæ¯:', error.message);
                console.error('é”™è¯¯å †æ ˆ:', error.stack);
                showMessage('å¯¼å…¥å¤±è´¥: ' + error.message + ' (è¯·æ£€æŸ¥æ§åˆ¶å°æŸ¥çœ‹è¯¦ç»†é”™è¯¯)', 'error');
            } finally {
                showLoading(false);
            }
        }

        // æ¸…é™¤ Cookie
        async function clearCookies() {
            if (!confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰å·²ä¿å­˜çš„ Cookie å—ï¼Ÿæ¸…é™¤åéœ€è¦é‡æ–°ç™»å½•ã€‚')) {
                return;
            }

            showLoading(true);

            try {
                const response = await fetch('/api/clear-cookies', {
                    method: 'POST'
                });

                const data = await response.json();

                if (response.ok) {
                    showMessage('Cookie å·²æ¸…é™¤');
                    cookiesData = '';
                    updateCookieDisplay();
                    checkLoginStatus();
                } else {
                    showMessage(data.error || 'æ¸…é™¤å¤±è´¥', 'error');
                }
            } catch (error) {
                showMessage('ç½‘ç»œé”™è¯¯ï¼š' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(message, type = 'success') {
            const messageArea = document.getElementById('messageArea');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.textContent = message;
            messageArea.appendChild(messageDiv);

            setTimeout(() => {
                messageDiv.remove();
            }, 5000);
        }

        // æ˜¾ç¤º/éšè—åŠ è½½çŠ¶æ€
        function showLoading(show) {
            const loading = document.getElementById('loading');
            if (show) {
                loading.classList.add('show');
            } else {
                loading.classList.remove('show');
            }
        }

        // æ‰“å¼€æµè§ˆå™¨ä¾›ç”¨æˆ·ç™»å½•
        async function openForLogin() {
            showLoading(true);

            try {
                const response = await fetch('/api/init-login', {
                    method: 'POST'
                });

                const data = await response.json();

                if (response.ok) {
                    if (data.cookieExpired) {
                        showMessage('âš ï¸ ' + data.message, 'error');
                        // è‡ªåŠ¨æ›´æ–° Cookie æ˜¾ç¤ºå’Œç™»å½•çŠ¶æ€
                        cookiesData = '';
                        updateCookieDisplay();
                        setTimeout(checkLoginStatus, 1000);
                    } else if (data.isLoggedIn) {
                        showMessage('æ£€æµ‹åˆ°å·²ç™»å½•çŠ¶æ€ï¼', 'success');
                        setTimeout(checkLoginStatus, 2000);
                    } else {
                        showMessage('æµè§ˆå™¨å·²æ‰“å¼€ï¼Œè¯·åœ¨æµè§ˆå™¨ä¸­ç™»å½•AnyRouter');
                        setTimeout(checkLoginStatus, 2000);
                    }
                } else {
                    showMessage(data.error || 'æ‰“å¼€æµè§ˆå™¨å¤±è´¥', 'error');
                }
            } catch (error) {
                showMessage('ç½‘ç»œé”™è¯¯ï¼š' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        async function checkLoginStatus() {
            try {
                const response = await fetch('/api/login-status');
                const data = await response.json();

                const statusElement = document.getElementById('loginStatus');

                if (data.success && data.isLoggedIn) {
                    statusElement.className = 'login-status logged-in';
                    statusElement.textContent = 'âœ… å·²ç™»å½• AnyRouter';
                    loadCookies(); // é‡æ–°åŠ è½½ Cookie
                } else if (data.success && !data.isLoggedIn) {
                    statusElement.className = 'login-status logged-out';
                    statusElement.textContent = 'âŒ æœªç™»å½•ï¼Œè¯·å…ˆç™»å½• AnyRouter';
                } else {
                    statusElement.className = 'login-status unknown';
                    statusElement.textContent = 'â“ ' + (data.message || 'æ— æ³•æ£€æŸ¥ç™»å½•çŠ¶æ€');
                }
            } catch (error) {
                const statusElement = document.getElementById('loginStatus');
                statusElement.className = 'login-status unknown';
                statusElement.textContent = 'â— æ£€æŸ¥ç™»å½•çŠ¶æ€æ—¶å‡ºé”™';
            }
        }

        // æ‰‹åŠ¨æ£€æŸ¥å¥–åŠ±
        async function manualCheck() {
            showLoading(true);

            try {
                const response = await fetch('/api/check', {
                    method: 'POST'
                });

                const data = await response.json();

                // åœ¨æ§åˆ¶å°è¾“å‡ºå®Œæ•´çš„è°ƒè¯•ä¿¡æ¯
                console.log('=== ç«‹å³æ£€æŸ¥å¥–åŠ± - å®Œæ•´å“åº” ===');
                console.log('å“åº”çŠ¶æ€:', response.status);
                console.log('å®Œæ•´æ•°æ®:', data);

                if (data.debug) {
                    console.log('--- è°ƒè¯•ä¿¡æ¯ ---');
                    console.log('sign_in æ¥å£å“åº”:', data.debug.signInResult);
                    console.log('user/self æ¥å£å“åº”:', data.debug.userInfo);
                    console.log('æå–çš„ quota:', data.debug.quota);
                    console.log('è®¡ç®—çš„ä½™é¢:', data.debug.calculatedBalance);
                    console.log('ç”¨æˆ·ID:', data.debug.savedUserId || data.userId);
                }

                if (response.ok) {
                    showMessage(`âœ… æ£€æŸ¥å®Œæˆï¼ä½™é¢ï¼š${data.balance}ï¼Œå¥–åŠ±ï¼š${data.reward}`);
                    loadRecords();
                    updateTodayStatus();
                    checkLoginStatus();
                } else {
                    showMessage(data.error || 'æ£€æŸ¥å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('è¯·æ±‚å¤±è´¥:', error);
                showMessage('ç½‘ç»œé”™è¯¯ï¼š' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // å…³é—­æµè§ˆå™¨
        async function closeBrowser() {
            showLoading(true);

            try {
                const response = await fetch('/api/close', {
                    method: 'POST'
                });

                const data = await response.json();

                if (response.ok) {
                    showMessage('æµè§ˆå™¨å·²å…³é—­');
                    checkLoginStatus();
                } else {
                    showMessage(data.error || 'å…³é—­å¤±è´¥', 'error');
                }
            } catch (error) {
                showMessage('ç½‘ç»œé”™è¯¯ï¼š' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // åŠ è½½æ£€æŸ¥è®°å½•
        async function loadRecords() {
            try {
                const response = await fetch('/api/records');
                const records = await response.json();

                const tbody = document.getElementById('recordsBody');
                tbody.innerHTML = '';

                if (records.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #999;">æš‚æ— è®°å½•</td></tr>';
                    return;
                }

                records.forEach(record => {
                    const row = document.createElement('tr');
                    const statusClass = record.status === 'success' ? 'status-success' : 'status-failed';

                    row.innerHTML = `
                        <td>${record.date}</td>
                        <td class="${statusClass}">${record.status === 'success' ? 'æˆåŠŸ' : 'å¤±è´¥'}</td>
                        <td>${record.balance || '--'}</td>
                        <td>${record.reward || '--'}</td>
                        <td>${record.message || '--'}</td>
                    `;
                    tbody.appendChild(row);
                });

                // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
                updateStats(records);
            } catch (error) {
                console.error('åŠ è½½è®°å½•å¤±è´¥:', error);
            }
        }

        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStats(records) {
            if (records.length === 0) return;

            const today = new Date().toISOString().split('T')[0];
            const todayRecord = records.find(r => r.date === today);

            if (todayRecord) {
                document.getElementById('currentBalance').textContent = todayRecord.balance || '--';
                document.getElementById('todayReward').textContent = todayRecord.reward || '--';
            }

            // è®¡ç®—è¿ç»­å¤©æ•°
            let streak = 0;
            for (let i = 0; i < records.length; i++) {
                if (records[i].status === 'success') {
                    streak++;
                } else {
                    break;
                }
            }
            document.getElementById('streakDays').textContent = streak + 'å¤©';
        }

        // æ›´æ–°ä»Šæ—¥çŠ¶æ€
        function updateTodayStatus() {
            const today = new Date().toISOString().split('T')[0];
            fetch('/api/records')
                .then(response => response.json())
                .then(records => {
                    const todayRecord = records.find(r => r.date === today);
                    const statusElement = document.getElementById('todayStatus');

                    if (todayRecord) {
                        statusElement.textContent = todayRecord.status === 'success' ? 'âœ… å·²å®Œæˆ' : 'âŒ å¤±è´¥';
                        statusElement.style.color = todayRecord.status === 'success' ? '#28a745' : '#dc3545';
                    } else {
                        statusElement.textContent = 'â³ å¾…æ£€æŸ¥';
                        statusElement.style.color = '#ffc107';
                    }
                })
                .catch(error => {
                    console.error('æ›´æ–°ä»Šæ—¥çŠ¶æ€å¤±è´¥:', error);
                });
        }

        // å®šæœŸåˆ·æ–° - æ¯5ç§’æ£€æŸ¥ä¸€æ¬¡ï¼Œç”¨äºè‡ªåŠ¨æ£€æµ‹ç™»å½•å’Œå®æ—¶æ›´æ–°è®°å½•
        setInterval(() => {
            checkLoginStatus();
            loadCookies(); // åŒæ—¶åˆ·æ–°Cookieæ˜¾ç¤º
            loadRecords(); // å®æ—¶æ›´æ–°æ‰“å¡è®°å½•
            updateTodayStatus(); // æ›´æ–°ä»Šæ—¥çŠ¶æ€
        }, 5000);
    </script>
</body>
</html>